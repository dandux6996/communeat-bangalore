<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Commun-EAT-y — Route Only (Debugged)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  body{font-family:'Poppins',sans-serif;margin:0;background:#fafafa;color:#222}
  header{background:linear-gradient(135deg,#FF6F61,#6B5B95);color:#fff;padding:20px;text-align:center}
  main{max-width:1200px;margin:20px auto;padding:12px}
  .controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-bottom:12px}
  .controls input, .controls button{padding:10px;border-radius:6px;border:1px solid #ccc}
  .controls button{background:#88B04B;color:#fff;border:none;cursor:pointer}
  .map-layout{display:grid;grid-template-columns:1fr 340px;gap:12px;align-items:start}
  #map{width:100%;height:640px;border-radius:8px;background:#eaeaea}
  .sidebar{background:#fff;border-radius:8px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06);min-height:200px;max-height:640px;overflow:auto}
  .status{font-style:italic;margin-top:8px;text-align:center}
  .error{color:red}
  @media(max-width:980px){.map-layout{grid-template-columns:1fr}#map{height:420px}.sidebar{max-height:420px}}
  .diagnostic{background:#fff5f5;border-left:4px solid #ff6f61;padding:8px;margin-top:8px;border-radius:6px;color:#8a1e1e}
</style>
</head>
<body>
  <header>
    <h1>Commun-EAT-y</h1>
    <div style="font-weight:300">Route preview — map only (start → end)</div>
  </header>

  <main>
    <section class="controls" aria-label="Route controls">
      <input id="route-start" placeholder="Start (address or city)" style="min-width:220px" />
      <input id="route-end" placeholder="End (address or city)" style="min-width:220px" />
      <button id="route-search-btn">Show on Map</button>
      <button id="route-reset-btn" style="background:#eee;color:#111;border:1px solid #ddd">Reset</button>
      <span id="route-status" class="status"></span>
    </section>

    <div class="map-layout">
      <div id="map" role="application" aria-label="Map showing route"></div>
      <aside class="sidebar" id="route-sidebar">
        <h3>Route summary</h3>
        <div id="route-summary">Enter start &amp; end and click "Show on Map".</div>
        <div id="diagnostic-container" style="margin-top:8px"></div>
      </aside>
    </div>
  </main>

<script>
  // Defensive wrapper so page doesn't break if maps fails
  let map, directionsService, directionsRenderer;

  function showDiagnostic(msg, isError = false) {
    const c = document.getElementById('diagnostic-container');
    c.innerHTML = `<div class="diagnostic">${isError ? '<strong style="color:#8a1e1e">Error:</strong> ' : ''}${msg}</div>`;
  }

  function clearDiagnostic() {
    document.getElementById('diagnostic-container').innerHTML = '';
  }

  function initMapSafe() {
    try {
      initMap();
    } catch (err) {
      console.error('initMap threw:', err);
      showDiagnostic('Initialization failed: ' + (err && err.message ? err.message : String(err)), true);
    }
  }

  // Called by google maps callback
  function initMap() {
    clearDiagnostic();
    directionsService = new google.maps.DirectionsService();
    directionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: false });
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat: 12.9716, lng: 77.5946 },
      zoom: 10,
      mapTypeControl: false
    });
    directionsRenderer.setMap(map);

    // Wire up buttons
    document.getElementById('route-search-btn').addEventListener('click', onRouteSearchClick);
    document.getElementById('route-reset-btn').addEventListener('click', resetMapRoute);
    // Success marker
    showDiagnostic('Google Maps loaded successfully. You should be able to draw a route now.');
  }

  function onRouteSearchClick() {
    const start = document.getElementById('route-start').value.trim();
    const end = document.getElementById('route-end').value.trim();
    const statusEl = document.getElementById('route-status');
    const summaryEl = document.getElementById('route-summary');
    summaryEl.textContent = '';
    statusEl.textContent = '';
    clearDiagnostic();

    if (!start || !end) {
      statusEl.textContent = 'Please enter both start and end addresses.';
      statusEl.className = 'status error';
      return;
    }
    if (!directionsService || !directionsRenderer) {
      showDiagnostic('Maps not initialized. Confirm your API key and that the Google script loaded.', true);
      return;
    }

    statusEl.textContent = 'Fetching route...';
    directionsService.route({
      origin: start,
      destination: end,
      travelMode: google.maps.TravelMode.DRIVING,
      provideRouteAlternatives: false
    }, (result, status) => {
      if (status !== 'OK' || !result || !result.routes || !result.routes.length) {
        statusEl.textContent = 'Failed to fetch route. Check addresses or API key restrictions.';
        statusEl.className = 'status error';
        console.warn('Directions status:', status, result);
        showDiagnostic('Directions request failed: ' + status + '. Open console for details.', true);
        return;
      }

      // Draw route and show summary
      directionsRenderer.setDirections(result);
      const route = result.routes[0];
      const leg = route.legs && route.legs[0];
      const distanceMeters = leg && leg.distance ? leg.distance.value : null;
      const durationSecs = leg && leg.duration ? leg.duration.value : null;
      const distanceKm = distanceMeters ? (distanceMeters/1000).toFixed(1) + ' km' : 'N/A';
      const durationStr = durationSecs ? formatDuration(durationSecs) : 'N/A';
      summaryEl.innerHTML = `<strong>Distance:</strong> ${distanceKm}<br/><strong>Estimated time:</strong> ${durationStr}`;

      // Fit map bounds to route
      const bounds = new google.maps.LatLngBounds();
      if (route.overview_path && route.overview_path.length) {
        route.overview_path.forEach(p => bounds.extend(p));
      } else if (leg && leg.steps) {
        leg.steps.forEach(s => { bounds.extend(s.start_location); bounds.extend(s.end_location); });
      }
      map.fitBounds(bounds, 60);
      statusEl.textContent = 'Route drawn.';
      statusEl.className = 'status';
    });
  }

  function resetMapRoute() {
    if (directionsRenderer) directionsRenderer.set('directions', null);
    document.getElementById('route-summary').textContent = 'Enter start & end and click "Show on Map".';
    document.getElementById('route-status').textContent = '';
    clearDiagnostic();
    if (map) { map.setCenter({ lat:12.9716, lng:77.5946 }); map.setZoom(10); }
  }

  function formatDuration(sec) {
    if (!sec && sec !== 0) return 'N/A';
    const hrs = Math.floor(sec/3600);
    const mins = Math.round((sec%3600)/60);
    return hrs>0 ? `${hrs} hr ${mins} min` : `${mins} min`;
  }

  // If Google script fails to load, show message to user
  function mapsScriptFailed() {
    showDiagnostic('Google Maps script failed to load. Check API key, billing, and network. Open console for script errors.', true);
    document.getElementById('route-status').textContent = 'Map load failed.';
    document.getElementById('route-status').className = 'status error';
  }

  // expose for callback
  window.initMap = initMapSafe;
  window.mapsScriptFailed = mapsScriptFailed;
</script>

<!-- IMPORTANT: Replace YOUR_API_KEY_HERE with a valid Google Maps JavaScript API key.
     If your key is restricted by HTTP referrers, make sure the page origin matches the allowed referrers. -->
<script async
  src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY_HERE&libraries=places&callback=initMap"
  onerror="mapsScriptFailed()"></script>

</body>
</html>
